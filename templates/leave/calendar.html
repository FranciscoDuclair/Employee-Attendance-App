{% extends 'leave/base_leave.html' %}
{% load humanize %}

{% block leave_title %}Leave Calendar{% endblock %}
{% block page_heading %}Leave Calendar{% endblock %}

{% block page_actions %}
<div class="d-flex">
    <div class="btn-group me-2">
        <button class="btn btn-outline-secondary" onclick="previousMonth()">
            <i class="fas fa-chevron-left"></i>
        </button>
        <button class="btn btn-outline-secondary" id="currentMonth">
            {{ current_month|date:"F Y" }}
        </button>
        <button class="btn btn-outline-secondary" onclick="nextMonth()">
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>
</div>
{% endblock %}

{% block leave_content %}
<div class="row">
    <div class="col-12">
        <!-- Calendar View -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    {% if is_manager %}Team Calendar{% else %}My Calendar{% endif %}
                </h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered calendar-table">
                        <thead class="table-light">
                            <tr>
                                <th class="text-center">Mon</th>
                                <th class="text-center">Tue</th>
                                <th class="text-center">Wed</th>
                                <th class="text-center">Thu</th>
                                <th class="text-center">Fri</th>
                                <th class="text-center">Sat</th>
                                <th class="text-center">Sun</th>
                            </tr>
                        </thead>
                        <tbody id="calendar-body">
                            <!-- Calendar days will be generated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upcoming Leave Requests -->
<div class="row">
    <div class="col-md-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Upcoming Leave</h6>
            </div>
            <div class="card-body">
                {% if upcoming_leaves %}
                    <div class="list-group list-group-flush">
                        {% for leave in upcoming_leaves %}
                        <div class="list-group-item px-0 py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    {% if is_manager %}
                                    <div class="me-3">
                                        <div class="font-weight-bold">{{ leave.user.get_full_name|default:leave.user.username }}</div>
                                        <div class="small text-muted">{{ leave.leave_type.name }}</div>
                                    </div>
                                    {% else %}
                                    <div class="me-3">
                                        <div class="font-weight-bold">{{ leave.leave_type.name }}</div>
                                        <div class="small text-muted">{{ leave.reason|truncatewords:5 }}</div>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="text-end">
                                    <div class="small">{{ leave.start_date|date:"M j" }} - {{ leave.end_date|date:"M j, Y" }}</div>
                                    {% if leave.status == 'pending' %}
                                        <span class="badge bg-warning">Pending</span>
                                    {% elif leave.status == 'approved' %}
                                        <span class="badge bg-success">Approved</span>
                                    {% elif leave.status == 'rejected' %}
                                        <span class="badge bg-danger">Rejected</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ leave.status|title }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-calendar-check fa-3x text-gray-300 mb-3"></i>
                        <p class="text-muted mb-0">No upcoming leave scheduled</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Leave Summary</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6 class="small font-weight-bold text-uppercase text-muted mb-2">This Month</h6>
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center">
                                <div class="h4 mb-0 text-primary">{{ leave_requests.count }}</div>
                                <div class="small text-muted">Total Requests</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <div class="h4 mb-0 text-success">{{ leave_requests|length }}</div>
                                <div class="small text-muted">Days Off</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 pt-3 border-top">
                    <h6 class="small font-weight-bold text-uppercase text-muted mb-2">Quick Actions</h6>
                    <div class="d-grid gap-2">
                        <a href="{% url 'leave:request_create' %}" class="btn btn-primary btn-sm">
                            <i class="fas fa-plus me-1"></i>New Leave Request
                        </a>
                        <a href="{% url 'leave:request_list' %}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-list me-1"></i>View All Requests
                        </a>
                        {% if is_manager %}
                        <a href="{% url 'leave:team_requests' %}" class="btn btn-outline-info btn-sm">
                            <i class="fas fa-users me-1"></i>Team Requests
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
    .calendar-table {
        table-layout: fixed;
    }
    
    .calendar-table th,
    .calendar-table td {
        width: 14.28%;
        height: 100px;
        vertical-align: top;
        padding: 8px;
        border: 1px solid #e3e6f0;
    }
    
    .calendar-table th {
        height: auto;
        text-align: center;
        font-weight: 600;
        background-color: #f8f9fc;
        color: #4e73df;
        text-transform: uppercase;
        font-size: 0.7rem;
        letter-spacing: 0.5px;
    }
    
    .calendar-day {
        position: relative;
        height: 100%;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    
    .calendar-day:hover {
        background-color: rgba(78, 115, 223, 0.05);
    }
    
    .calendar-day-number {
        font-weight: 600;
        color: #5a5c69;
        margin-bottom: 5px;
    }
    
    .calendar-day.today {
        background-color: rgba(78, 115, 223, 0.1);
    }
    
    .calendar-day.today .calendar-day-number {
        color: #4e73df;
        font-weight: 700;
    }
    
    .calendar-day.other-month {
        background-color: #f8f9fc;
        opacity: 0.6;
    }
    
    .calendar-day.other-month .calendar-day-number {
        color: #d1d3e2;
    }
    
    .calendar-event {
        background-color: #4e73df;
        color: white;
        padding: 2px 4px;
        border-radius: 3px;
        font-size: 0.7rem;
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        cursor: pointer;
    }
    
    .calendar-event.approved {
        background-color: #1cc88a;
    }
    
    .calendar-event.pending {
        background-color: #f6c23e;
        color: #333;
    }
    
    .calendar-event.rejected {
        background-color: #e74a3b;
    }
    
    @media (max-width: 768px) {
        .calendar-table th,
        .calendar-table td {
            height: 60px;
            padding: 4px;
        }
        
        .calendar-day-number {
            font-size: 0.8rem;
        }
        
        .calendar-event {
            font-size: 0.6rem;
            padding: 1px 2px;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentDate = new Date({{ current_year }}, {{ current_month }} - 1, 1);
    
    function generateCalendar() {
        const calendarBody = document.getElementById('calendar-body');
        const currentMonthButton = document.getElementById('currentMonth');
        
        // Update month display
        currentMonthButton.textContent = currentDate.toLocaleDateString('en-US', { 
            month: 'long', 
            year: 'numeric' 
        });
        
        // Clear existing calendar
        calendarBody.innerHTML = '';
        
        // Get first day of month and number of days
        const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
        const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
        const daysInMonth = lastDay.getDate();
        
        // Get first Monday of the calendar view
        const startDate = new Date(firstDay);
        const dayOfWeek = firstDay.getDay();
        const daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
        startDate.setDate(firstDay.getDate() - daysToSubtract);
        
        // Generate 6 weeks of calendar
        for (let week = 0; week < 6; week++) {
            const row = document.createElement('tr');
            
            for (let day = 0; day < 7; day++) {
                const cellDate = new Date(startDate);
                cellDate.setDate(startDate.getDate() + (week * 7) + day);
                
                const cell = document.createElement('td');
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                
                // Add day number
                const dayNumber = document.createElement('div');
                dayNumber.className = 'calendar-day-number';
                dayNumber.textContent = cellDate.getDate();
                dayDiv.appendChild(dayNumber);
                
                // Check if it's today
                const today = new Date();
                if (cellDate.toDateString() === today.toDateString()) {
                    dayDiv.classList.add('today');
                }
                
                // Check if it's in current month
                if (cellDate.getMonth() !== currentDate.getMonth()) {
                    dayDiv.classList.add('other-month');
                }
                
                // Add leave events (simplified - in real app would come from server)
                {% for leave in leave_requests %}
                const leaveStart = new Date('{{ leave.start_date|date:"Y-m-d" }}');
                const leaveEnd = new Date('{{ leave.end_date|date:"Y-m-d" }}');
                
                if (cellDate >= leaveStart && cellDate <= leaveEnd) {
                    const event = document.createElement('div');
                    event.className = 'calendar-event {{ leave.status }}';
                    event.textContent = '{% if is_manager %}{{ leave.user.get_short_name|default:leave.user.username }}{% else %}{{ leave.leave_type.name }}{% endif %}';
                    event.title = '{{ leave.leave_type.name }} - {{ leave.status|title }}';
                    dayDiv.appendChild(event);
                }
                {% endfor %}
                
                cell.appendChild(dayDiv);
                row.appendChild(cell);
            }
            
            calendarBody.appendChild(row);
        }
    }
    
    window.previousMonth = function() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        generateCalendar();
    };
    
    window.nextMonth = function() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        generateCalendar();
    };
    
    // Initial calendar generation
    generateCalendar();
});
</script>
{% endblock %}
