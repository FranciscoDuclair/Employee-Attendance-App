{% extends 'leave/base_leave.html' %}
{% load humanize %}

{% block leave_title %}Leave Request Details{% endblock %}
{% block page_heading %}Leave Request Details{% endblock %}

{% block page_actions %}
{% if object.status == 'pending' and object.user == request.user %}
    <a href="{% url 'leave:request_edit' object.pk %}" class="btn btn-warning btn-icon-split me-2">
        <span class="icon text-white-50">
            <i class="fas fa-edit"></i>
        </span>
        <span class="text">Edit</span>
    </a>
{% endif %}
{% if object.status == 'pending' and can_approve %}
    <div class="btn-group me-2">
        <a href="{% url 'leave:review_request' object.pk 'approve' %}" class="btn btn-success">
            <i class="fas fa-check me-1"></i> Approve
        </a>
        <a href="{% url 'leave:review_request' object.pk 'reject' %}" class="btn btn-danger">
            <i class="fas fa-times me-1"></i> Reject
        </a>
    </div>
{% endif %}
{% if object.can_cancel %}
    <a href="{% url 'leave:request_cancel' object.pk %}" class="btn btn-outline-danger me-2">
        <i class="fas fa-times me-1"></i> Cancel Request
    </a>
{% endif %}
{% if request.user.is_staff %}
    <div class="dropdown d-inline-block">
        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="adminActions" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-cog"></i> Admin
        </button>
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="adminActions">
            <li><a class="dropdown-item" href="#">
                <i class="fas fa-edit me-2"></i>Edit as Admin
            </a></li>
            <li><a class="dropdown-item" href="#">
                <i class="fas fa-exchange-alt me-2"></i>Change Status
            </a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item text-danger" href="#">
                <i class="fas fa-trash-alt me-2"></i>Delete Request
            </a></li>
        </ul>
    </div>
{% endif %}
{% endblock %}

{% block leave_content %}
<div class="row">
    <div class="col-lg-8">
        <!-- Leave Details Card -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">Leave Request Information</h6>
                <span class="badge bg-{{ object.status_badge_class }}">
                    {{ object.get_status_display }}
                </span>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center mb-3">
                            <div class="flex-shrink-0">
                                <img class="rounded-circle" src="{{ object.user.profile.image.url|default:'/static/img/undraw_profile.svg' }}" 
                                     alt="Profile" width="60" height="60">
                            </div>
                            <div class="ms-3">
                                <h5 class="mb-0">{{ object.user.get_full_name|default:object.user.username }}</h5>
                                <span class="text-muted">{{ object.user.get_role_display }}</span>
                            </div>
                        </div>
                        
                        <dl class="row">
                            <dt class="col-sm-5">Employee ID:</dt>
                            <dd class="col-sm-7">{{ object.user.employee_id|default:'N/A' }}</dd>
                            
                            <dt class="col-sm-5">Department:</dt>
                            <dd class="col-sm-7">{{ object.user.department|default:'N/A' }}</dd>
                            
                            <dt class="col-sm-5">Position:</dt>
                            <dd class="col-sm-7">{{ object.user.position|default:'N/A' }}</dd>
                            
                            <dt class="col-sm-5">Hire Date:</dt>
                            <dd class="col-sm-7">{{ object.user.date_joined|date:"M d, Y" }}</dd>
                        </dl>
                    </div>
                    <div class="col-md-6">
                        <div class="p-3 bg-light rounded">
                            <h6 class="font-weight-bold text-primary mb-3">Leave Summary</h6>
                            <dl class="row">
                                <dt class="col-sm-5">Leave Type:</dt>
                                <dd class="col-sm-7">
                                    {{ object.leave_type.name }}
                                    {% if object.leave_type.is_paid %}
                                        <span class="badge bg-success">Paid</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Unpaid</span>
                                    {% endif %}
                                </dd>
                                
                                <dt class="col-sm-5">Date Range:</dt>
                                <dd class="col-sm-7">
                                    {{ object.start_date|date:"M d, Y" }} - {{ object.end_date|date:"M d, Y" }}
                                </dd>
                                
                                <dt class="col-sm-5">Duration:</dt>
                                <dd class="col-sm-7">
                                    {{ object.total_days }} day{{ object.total_days|pluralize }}
                                    {% if object.is_half_day %}
                                        <span class="text-muted">({{ object.get_half_day_period_display }})</span>
                                    {% endif %}
                                </dd>
                                
                                <dt class="col-sm-5">Requested On:</dt>
                                <dd class="col-sm-7">{{ object.created_at|date:"M d, Y h:i A" }}</dd>
                                
                                {% if object.status == 'approved' %}
                                <dt class="col-sm-5">Approved By:</dt>
                                <dd class="col-sm-7">
                                    {{ object.approved_by.get_full_name|default:object.approved_by.username }}
                                    <div class="text-muted small">{{ object.approved_at|date:"M d, Y h:i A" }}</div>
                                </dd>
                                {% endif %}
                                
                                {% if object.status == 'rejected' and object.updated_by %}
                                <dt class="col-sm-5">Rejected By:</dt>
                                <dd class="col-sm-7">
                                    {{ object.updated_by.get_full_name|default:object.updated_by.username }}
                                    <div class="text-muted small">{{ object.updated_at|date:"M d, Y h:i A" }}</div>
                                </dd>
                                {% endif %}
                                
                                {% if object.status == 'cancelled' and object.updated_by %}
                                <dt class="col-sm-5">Cancelled By:</dt>
                                <dd class="col-sm-7">
                                    {{ object.updated_by.get_full_name|default:object.updated_by.username }}
                                    <div class="text-muted small">{{ object.updated_at|date:"M d, Y h:i A" }}</div>
                                </dd>
                                {% endif %}
                            </dl>
                        </div>
                    </div>
                </div>
                
                <!-- Reason and Notes -->
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="font-weight-bold text-primary">Reason for Leave</h6>
                        <div class="p-3 bg-light rounded mb-3">
                            {{ object.reason|linebreaksbr }}
                        </div>
                        
                        {% if object.emergency_contact or object.emergency_phone %}
                        <h6 class="font-weight-bold text-primary mt-4">Emergency Contact</h6>
                        <div class="p-3 bg-light rounded">
                            <p class="mb-1">
                                <i class="fas fa-user me-2"></i>
                                {{ object.emergency_contact|default:'N/A' }}
                            </p>
                            <p class="mb-0">
                                <i class="fas fa-phone me-2"></i>
                                {{ object.emergency_phone|default:'N/A' }}
                            </p>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-6">
                        {% if object.approval_notes or object.notes %}
                        <h6 class="font-weight-bold text-primary">
                            {% if object.status == 'approved' %}Approval Notes
                            {% elif object.status == 'rejected' %}Rejection Reason
                            {% else %}Notes{% endif %}
                        </h6>
                        <div class="p-3 bg-light rounded mb-3">
                            {{ object.approval_notes|default:object.notes|default:'No notes provided.'|linebreaksbr }}
                        </div>
                        {% endif %}
                        
                        {% if object.attachments.exists %}
                        <h6 class="font-weight-bold text-primary mt-4">Attachments</h6>
                        <div class="p-3 bg-light rounded">
                            <div class="list-group">
                                {% for attachment in object.attachments.all %}
                                <a href="{{ attachment.file.url }}" class="list-group-item list-group-item-action" target="_blank">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">
                                            <i class="fas fa-file-{{ attachment.file_icon }} text-{{ attachment.file_color }} me-2"></i>
                                            {{ attachment.filename }}
                                        </h6>
                                        <small>{{ attachment.file.size|filesizeformat }}</small>
                                    </div>
                                    <small class="text-muted">
                                        {{ attachment.uploaded_at|timesince }} ago
                                        {% if attachment.uploaded_by %}
                                            by {{ attachment.uploaded_by.get_full_name|default:attachment.uploaded_by.username }}
                                        {% endif %}
                                    </small>
                                </a>
                                {% endfor %}
                            </div>
                            
                            {% if object.status == 'pending' and object.user == request.user %}
                            <form class="mt-3" id="attachmentForm" method="post" enctype="multipart/form-data" action="{% url 'leave:add_attachment' object.pk %}">
                                {% csrf_token %}
                                <div class="input-group">
                                    <input type="file" class="form-control form-control-sm" name="file" required>
                                    <button class="btn btn-primary btn-sm" type="submit">
                                        <i class="fas fa-upload"></i> Upload
                                    </button>
                                </div>
                                <small class="text-muted">Maximum file size: 5MB. Allowed formats: PDF, JPG, PNG, DOC, DOCX</small>
                            </form>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Comments Section -->
                {% if object.comments.exists or object.status == 'pending' %}
                <div class="mt-4">
                    <h6 class="font-weight-bold text-primary mb-3">
                        Comments 
                        <span class="badge bg-secondary">{{ object.comments.count }}</span>
                    </h6>
                    
                    <div class="bg-light p-3 rounded mb-3">
                        {% if object.comments.exists %}
                        <div class="mb-4">
                            {% for comment in object.comments.all %}
                            <div class="d-flex mb-3">
                                <img src="{{ comment.user.profile.image.url|default:'/static/img/undraw_profile.svg' }}" 
                                     class="rounded-circle me-3" width="40" height="40" alt="{{ comment.user.get_full_name }}">
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <h6 class="mb-0">
                                            {{ comment.user.get_full_name|default:comment.user.username }}
                                            {% if comment.user == object.user %}
                                                <span class="badge bg-primary">Requester</span>
                                            {% endif %}
                                            {% if comment.user == object.approved_by %}
                                                <span class="badge bg-success">Approver</span>
                                            {% endif %}
                                        </h6>
                                        <small class="text-muted">{{ comment.created_at|timesince }} ago</small>
                                    </div>
                                    <div class="p-2 bg-white rounded">
                                        {{ comment.content|linebreaksbr }}
                                    </div>
                                    {% if comment.attachments.exists %}
                                    <div class="mt-2">
                                        {% for attachment in comment.attachments.all %}
                                        <a href="{{ attachment.file.url }}" class="badge bg-light text-dark me-1 mb-1" target="_blank">
                                            <i class="fas fa-paperclip me-1"></i> {{ attachment.filename }}
                                        </a>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        {% if object.status == 'pending' %}
                        <form method="post" action="{% url 'leave:add_comment' object.pk %}" id="commentForm">
                            {% csrf_token %}
                            <div class="form-group mb-2">
                                <textarea name="content" class="form-control" rows="3" 
                                          placeholder="Add a comment..." required></textarea>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="attachFileBtn">
                                        <i class="fas fa-paperclip"></i> Attach File
                                    </button>
                                    <input type="file" id="fileInput" name="file" style="display: none;">
                                </div>
                                <button type="submit" class="btn btn-primary btn-sm">
                                    <i class="far fa-paper-plane me-1"></i> Post Comment
                                </button>
                            </div>
                        </form>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
            
            <div class="card-footer bg-white d-flex justify-content-between">
                <div>
                    <small class="text-muted">
                        Created: {{ object.created_at|date:"M d, Y h:i A" }}
                        {% if object.created_by %}
                            by {{ object.created_by.get_full_name|default:object.created_by.username }}
                        {% endif %}
                    </small>
                </div>
                <div>
                    <small class="text-muted">
                        Last Updated: {{ object.updated_at|date:"M d, Y h:i A" }}
                        {% if object.updated_by and object.updated_by != object.created_by %}
                            by {{ object.updated_by.get_full_name|default:object.updated_by.username }}
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>
        
        <!-- Related Leaves Card (for managers/admins) -->
        {% if related_leaves %}
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    Other Leaves by {{ object.user.get_full_name|default:object.user.username }}
                </h6>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    {% for leave in related_leaves|slice:":5" %}
                    <a href="{% url 'leave:detail' leave.pk %}" 
                       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">
                                {{ leave.leave_type.name }}
                                <span class="badge bg-{{ leave.status_badge_class }} ms-2">
                                    {{ leave.get_status_display }}
                                </span>
                            </h6>
                            <small class="text-muted">
                                {{ leave.start_date|date:"M d, Y" }} - {{ leave.end_date|date:"M d, Y" }}
                                <span class="mx-1">•</span>
                                {{ leave.total_days }} day{{ leave.total_days|pluralize }}
                            </small>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </a>
                    {% endfor %}
                    {% if related_leaves|length > 5 %}
                    <a href="{% url 'leave:user_requests' object.user.pk %}" 
                       class="list-group-item list-group-item-action text-center text-primary">
                        View all leaves by this employee
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    
    <div class="col-lg-4">
        <!-- Leave Balance Card -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Leave Balance</h6>
            </div>
            <div class="card-body">
                <div class="text-center mb-4">
                    <div class="circular-progress mx-auto" 
                         data-percent="{{ leave_balance.remaining_percentage|default:0 }}"
                         data-color="{{ leave_balance.remaining_percentage|default:0|percentage_color }}">
                        <div class="circle-progress-value">
                            <span class="h4 font-weight-bold">{{ leave_balance.remaining_days|default:0 }}</span>
                            <span class="d-block small text-muted">Days Left</span>
                        </div>
                    </div>
                    <h5 class="mt-3 mb-1">{{ object.leave_type.name }}</h5>
                    <p class="text-muted small mb-0">
                        {{ leave_balance.used_days|default:0 }} of {{ leave_balance.total_allocated|default:0 }} days used
                    </p>
                    <p class="mt-2 mb-0">
                        <span class="badge bg-{{ leave_balance.remaining_days|days_left_badge_class }}">
                            {% if leave_balance.remaining_days > 5 %}
                                <i class="fas fa-check-circle me-1"></i> Good Balance
                            {% elif leave_balance.remaining_days > 0 %}
                                <i class="fas fa-exclamation-triangle me-1"></i> Low Balance
                            {% else %}
                                <i class="fas fa-times-circle me-1"></i> No Balance
                            {% endif %}
                        </span>
                    </p>
                </div>
                
                <div class="mt-4">
                    <h6 class="font-weight-bold text-primary mb-3">Leave History (Last 12 Months)</h6>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Approved</span>
                            <span>{{ leave_stats.approved_days }} days</span>
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar bg-success" role="progressbar" 
                                 style="width: {{ leave_stats.approved_percentage }}%" 
                                 aria-valuenow="{{ leave_stats.approved_percentage }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Pending</span>
                            <span>{{ leave_stats.pending_days }} days</span>
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar bg-warning" role="progressbar" 
                                 style="width: {{ leave_stats.pending_percentage }}%" 
                                 aria-valuenow="{{ leave_stats.pending_percentage }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-0">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Rejected</span>
                            <span>{{ leave_stats.rejected_days }} days</span>
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar bg-danger" role="progressbar" 
                                 style="width: {{ leave_stats.rejected_percentage }}%" 
                                 aria-valuenow="{{ leave_stats.rejected_percentage }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 pt-3 border-top">
                    <h6 class="font-weight-bold text-primary mb-3">Quick Actions</h6>
                    <div class="d-grid gap-2">
                        {% if object.status == 'approved' %}
                        <a href="#" class="btn btn-outline-primary btn-sm text-start">
                            <i class="fas fa-file-pdf me-2"></i> Download Approval Letter
                        </a>
                        {% endif %}
                        <a href="#" class="btn btn-outline-secondary btn-sm text-start">
                            <i class="fas fa-envelope me-2"></i> Send Reminder
                        </a>
                        {% if object.user == request.user %}
                        <a href="{% url 'leave:request_create' %}?duplicate={{ object.pk }}" 
                           class="btn btn-outline-success btn-sm text-start">
                            <i class="fas fa-copy me-2"></i> Duplicate Request
                        </a>
                        {% endif %}
                        <a href="#" class="btn btn-outline-info btn-sm text-start" data-bs-toggle="modal" data-bs-target="#timelineModal">
                            <i class="fas fa-history me-2"></i> View Timeline
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Team Coverage (for managers) -->
        {% if team_coverage %}
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Team Coverage</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6 class="small font-weight-bold text-uppercase text-muted mb-2">Team Members Available</h6>
                    <div class="d-flex align-items-center">
                        <div class="progress w-100 me-3" style="height: 20px;">
                            <div class="progress-bar bg-success" role="progressbar" 
                                 style="width: {{ team_coverage.available_percentage }}%" 
                                 aria-valuenow="{{ team_coverage.available_percentage }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                {{ team_coverage.available_members }}/{{ team_coverage.total_members }}
                            </div>
                        </div>
                        <span class="small font-weight-bold">{{ team_coverage.available_percentage }}%</span>
                    </div>
                </div>
                
                <div class="mb-3">
                    <h6 class="small font-weight-bold text-uppercase text-muted mb-2">On Leave</h6>
                    {% if team_coverage.on_leave %}
                    <div class="list-group list-group-flush">
                        {% for member in team_coverage.on_leave|slice:":3" %}
                        <div class="list-group-item px-0 py-2">
                            <div class="d-flex align-items-center">
                                <img src="{{ member.user.profile.image.url|default:'/static/img/undraw_profile.svg' }}" 
                                     class="rounded-circle me-3" width="32" height="32" alt="{{ member.user.get_full_name }}">
                                <div class="flex-grow-1">
                                    <h6 class="mb-0 small">{{ member.user.get_full_name|default:member.user.username }}</h6>
                                    <small class="text-muted">
                                        {{ member.leave_type.name }} • 
                                        {{ member.start_date|date:"M d" }} - {{ member.end_date|date:"M d" }}
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        
                        {% if team_coverage.on_leave|length > 3 %}
                        <a href="#" class="list-group-item list-group-item-action text-center small py-2">
                            View all {{ team_coverage.on_leave|length }} team members on leave
                        </a>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="alert alert-success small mb-0">
                        <i class="fas fa-check-circle me-1"></i> All team members are available during this period.
                    </div>
                    {% endif %}
                </div>
                
                <div class="mt-4 pt-3 border-top">
                    <a href="#" class="btn btn-outline-primary btn-sm w-100">
                        <i class="fas fa-user-plus me-1"></i> Assign Cover
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- System Information (for admins) -->
        {% if request.user.is_staff %}
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">System Information</h6>
            </div>
            <div class="card-body">
                <dl class="small mb-0">
                    <dt class="text-muted">Request ID</dt>
                    <dd class="mb-2">{{ object.id }}</dd>
                    
                    <dt class="text-muted">IP Address</dt>
                    <dd class="mb-2">{{ object.ip_address|default:'N/A' }}</dd>
                    
                    <dt class="text-muted">User Agent</dt>
                    <dd class="mb-2">
                        <span data-bs-toggle="tooltip" title="{{ object.user_agent|default:'N/A' }}">
                            {{ object.user_agent|truncatechars:30|default:'N/A' }}
                        </span>
                    </dd>
                    
                    <dt class="text-muted">Last Updated By</dt>
                    <dd class="mb-0">
                        {{ object.updated_by.get_full_name|default:object.updated_by.username|default:'System' }}
                        <div class="text-muted small">{{ object.updated_at|timesince }} ago</div>
                    </dd>
                </dl>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Timeline Modal -->
<div class="modal fade" id="timelineModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Request Timeline</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-marker">
                            <i class="fas fa-circle text-primary"></i>
                        </div>
                        <div class="timeline-content">
                            <h6 class="mb-1">Request Created</h6>
                            <p class="text-muted small mb-0">
                                {{ object.created_at|date:"M d, Y h:i A" }}
                                {% if object.created_by %}
                                    by {{ object.created_by.get_full_name|default:object.created_by.username }}
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    
                    {% if object.status == 'approved' %}
                    <div class="timeline-item">
                        <div class="timeline-marker">
                            <i class="fas fa-check-circle text-success"></i>
                        </div>
                        <div class="timeline-content">
                            <h6 class="mb-1">Request Approved</h6>
                            <p class="text-muted small mb-0">
                                {{ object.approved_at|date:"M d, Y h:i A" }}
                                by {{ object.approved_by.get_full_name|default:object.approved_by.username }}
                            </p>
                            {% if object.approval_notes %}
                            <div class="alert alert-light p-2 mt-2 small">
                                {{ object.approval_notes|linebreaksbr }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% elif object.status == 'rejected' %}
                    <div class="timeline-item">
                        <div class="timeline-marker">
                            <i class="fas fa-times-circle text-danger"></i>
                        </div>
                        <div class="timeline-content">
                            <h6 class="mb-1">Request Rejected</h6>
                            <p class="text-muted small mb-0">
                                {{ object.updated_at|date:"M d, Y h:i A" }}
                                by {{ object.updated_by.get_full_name|default:object.updated_by.username }}
                            </p>
                            {% if object.notes %}
                            <div class="alert alert-light p-2 mt-2 small">
                                {{ object.notes|linebreaksbr }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% elif object.status == 'cancelled' %}
                    <div class="timeline-item">
                        <div class="timeline-marker">
                            <i class="fas fa-ban text-warning"></i>
                        </div>
                        <div class="timeline-content">
                            <h6 class="mb-1">Request Cancelled</h6>
                            <p class="text-muted small mb-0">
                                {{ object.updated_at|date:"M d, Y h:i A" }}
                                {% if object.updated_by %}
                                    by {{ object.updated_by.get_full_name|default:object.updated_by.username }}
                                {% else %}
                                    by System
                                {% endif %}
                            </p>
                            {% if object.notes %}
                            <div class="alert alert-light p-2 mt-2 small">
                                {{ object.notes|linebreaksbr }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% for comment in object.comments.all %}
                    <div class="timeline-item">
                        <div class="timeline-marker">
                            <i class="fas fa-comment text-info"></i>
                        </div>
                        <div class="timeline-content">
                            <h6 class="mb-1">
                                {{ comment.user.get_full_name|default:comment.user.username }}
                                <small class="text-muted">commented</small>
                            </h6>
                            <p class="mb-1">{{ comment.content|truncatewords:20 }}</p>
                            <p class="text-muted small mb-0">
                                {{ comment.created_at|date:"M d, Y h:i A" }}
                            </p>
                        </div>
                    </div>
                    {% endfor %}
                    
                    {% if object.attachments.exists %}
                    <div class="timeline-item">
                        <div class="timeline-marker">
                            <i class="fas fa-paperclip text-secondary"></i>
                        </div>
                        <div class="timeline-content">
                            <h6 class="mb-1">
                                {{ object.attachments.count }} File{{ object.attachments.count|pluralize }} Attached
                            </h6>
                            <p class="text-muted small mb-0">
                                Last attached: {{ object.attachments.latest.uploaded_at|date:"M d, Y h:i A" }}
                            </p>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if object.status == 'pending' %}
                    <div class="timeline-item">
                        <div class="timeline-marker">
                            <i class="far fa-clock text-warning"></i>
                        </div>
                        <div class="timeline-content">
                            <h6 class="mb-1">Waiting for Approval</h6>
                            <p class="text-muted small mb-0">
                                Pending since {{ object.created_at|timesince }} ago
                            </p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">
                    <i class="fas fa-download me-1"></i> Export Timeline
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
.timeline {
    position: relative;
    padding-left: 2rem;
    margin: 0 0 0 1rem;
    border-left: 2px solid #e9ecef;
}

.timeline-item {
    position: relative;
    padding-bottom: 1.5rem;
}

.timeline-marker {
    position: absolute;
    left: -2.5rem;
    width: 2rem;
    text-align: center;
    color: #4e73df;
}

.timeline-content {
    padding-left: 1rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid #f0f0f0;
}

.timeline-item:last-child .timeline-content {
    border-bottom: none;
}

.circular-progress {
    position: relative;
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background: #f5f5f5;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
}

.circular-progress::before {
    content: '';
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: conic-gradient(
        var(--progress-color, #4e73df) 0% calc(var(--progress-value, 0) * 1%),
        #e9ecef calc(var(--progress-value, 0) * 1%) 100%
    );
    transform: rotate(-90deg);
    z-index: 1;
}

.circle-progress-value {
    position: relative;
    z-index: 2;
    text-align: center;
    background: white;
    width: 100px;
    height: 100px;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
}

/* Status badge colors */
.bg-pending { background-color: #f6c23e !important; }
.bg-approved { background-color: #1cc88a !important; }
.bg-rejected { background-color: #e74a3b !important; }
.bg-cancelled { background-color: #6c757d !important; }

/* Responsive adjustments */
@media (max-width: 991.98px) {
    .timeline {
        padding-left: 1.5rem;
        margin-left: 0.5rem;
    }
    
    .timeline-marker {
        left: -1.75rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize circular progress
    const circularProgress = document.querySelector('.circular-progress');
    if (circularProgress) {
        const percent = circularProgress.getAttribute('data-percent');
        const color = circularProgress.getAttribute('data-color') || '#4e73df';
        circularProgress.style.setProperty('--progress-value', percent);
        circularProgress.style.setProperty('--progress-color', color);
    }
    
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // File input handler for comments
    const attachFileBtn = document.getElementById('attachFileBtn');
    const fileInput = document.getElementById('fileInput');
    
    if (attachFileBtn && fileInput) {
        attachFileBtn.addEventListener('click', function() {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const fileName = this.files[0].name;
                attachFileBtn.innerHTML = `<i class="fas fa-paperclip me-1"></i> ${fileName}`;
            }
        });
    }
    
    // Handle comment form submission
    const commentForm = document.getElementById('commentForm');
    if (commentForm) {
        commentForm.addEventListener('submit', function(e) {
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Posting...';
        });
    }
    
    // Handle attachment form submission
    const attachmentForm = document.getElementById('attachmentForm');
    if (attachmentForm) {
        attachmentForm.addEventListener('submit', function(e) {
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Uploading...';
        });
    }
});
</script>
{% endblock %}
