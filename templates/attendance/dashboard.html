{% extends 'base.html' %}

{% block title %}Dashboard - Employee Attendance System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-tachometer-alt me-2"></i>Dashboard
            <small class="text-muted">Welcome, {{ user.get_full_name|default:user.username }}</small>
        </h1>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card attendance-card h-100">
            <div class="card-body text-center">
                <h5 class="card-title">
                    <i class="fas fa-sign-in-alt text-success me-2"></i>Check In
                </h5>
                {% if today_attendance and today_attendance.attendance_type == 'check_in' %}
                    <p class="text-success">
                        <i class="fas fa-check-circle me-1"></i>
                        Already checked in at {{ today_attendance.check_in_time|time:"H:i" }}
                    </p>
                {% else %}
                    <button class="btn btn-success btn-lg" onclick="checkIn()">
                        <i class="fas fa-camera me-2"></i>Check In Now
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card attendance-card h-100">
            <div class="card-body text-center">
                <h5 class="card-title">
                    <i class="fas fa-sign-out-alt text-danger me-2"></i>Check Out
                </h5>
                {% if today_attendance and today_attendance.attendance_type == 'check_out' %}
                    <p class="text-success">
                        <i class="fas fa-check-circle me-1"></i>
                        Already checked out
                    </p>
                {% else %}
                    <button class="btn btn-danger btn-lg" onclick="checkOut()" 
                            {% if not today_attendance or today_attendance.attendance_type != 'check_in' %}disabled{% endif %}>
                        <i class="fas fa-camera me-2"></i>Check Out Now
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Status Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">{{ month_attendance_count }}</h4>
                        <p class="mb-0">Days This Month</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-calendar-check fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">{{ month_late_count }}</h4>
                        <p class="mb-0">Late Days</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-clock fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card {% if face_setup %}bg-success{% else %}bg-secondary{% endif %} text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="mb-0">Face Recognition</h6>
                        <p class="mb-0">{% if face_setup %}Setup Complete{% else %}Not Setup{% endif %}</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-user-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="mb-0">Today's Status</h6>
                        <p class="mb-0">
                            {% if today_attendance %}
                                {{ today_attendance.get_status_display }}
                            {% else %}
                                Not Checked In
                            {% endif %}
                        </p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-info-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Face Recognition Setup Alert -->
{% if not face_setup %}
<div class="alert alert-warning" role="alert">
    <h5 class="alert-heading">
        <i class="fas fa-exclamation-triangle me-2"></i>Face Recognition Not Setup
    </h5>
    <p>Set up face recognition for faster and more secure attendance tracking.</p>
    <a href="{% url 'attendance_web:face_setup' %}" class="btn btn-warning">
        <i class="fas fa-user-plus me-2"></i>Setup Face Recognition
    </a>
</div>
{% endif %}

<!-- Recent Attendance -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>Recent Attendance
                </h5>
            </div>
            <div class="card-body">
                {% if recent_attendance %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Time</th>
                                    <th>Status</th>
                                    <th>Face Verified</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in recent_attendance %}
                                <tr>
                                    <td>{{ record.date }}</td>
                                    <td>
                                        <span class="badge {% if record.attendance_type == 'check_in' %}bg-success{% else %}bg-danger{% endif %}">
                                            {{ record.get_attendance_type_display }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if record.check_in_time %}
                                            {{ record.check_in_time|time:"H:i" }}
                                        {% elif record.check_out_time %}
                                            {{ record.check_out_time|time:"H:i" }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge 
                                            {% if record.status == 'present' %}bg-success
                                            {% elif record.status == 'late' %}bg-warning
                                            {% elif record.status == 'absent' %}bg-danger
                                            {% else %}bg-secondary{% endif %}">
                                            {{ record.get_status_display }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if record.face_verified %}
                                            <i class="fas fa-check-circle text-success"></i>
                                            {% if record.face_confidence %}
                                                ({{ record.face_confidence|floatformat:0 }}%)
                                            {% endif %}
                                        {% else %}
                                            <i class="fas fa-times-circle text-muted"></i>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted text-center">No attendance records found.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Camera Modal -->
<div class="modal fade" id="cameraModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cameraModalTitle">
                    <i class="fas fa-camera me-2"></i>Attendance Check
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <video id="video" class="face-camera mb-3" autoplay></video>
                <canvas id="canvas" style="display: none;"></canvas>
                
                <div class="d-grid gap-2">
                    <button id="captureBtn" class="btn btn-primary btn-lg">
                        <i class="fas fa-camera me-2"></i>Capture Photo
                    </button>
                    <button id="skipBtn" class="btn btn-outline-secondary">
                        Skip Face Recognition
                    </button>
                </div>
                
                <div id="processingMsg" class="mt-3" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Processing...</span>
                    </div>
                    <p class="mt-2" id="processingText">Processing attendance...</p>
                    <small class="text-muted">Face recognition may take 5-10 seconds</small>
                </div>
                
                <!-- Status Messages -->
                <div id="statusMsg" class="alert alert-info mt-3" style="display: none;">
                    <i class="fas fa-info-circle me-2"></i>
                    <span id="statusText">Ready...</span>
                </div>
                
                <div id="successMsg" class="alert alert-success mt-3" style="display: none;">
                    <i class="fas fa-check-circle me-2"></i>
                    <span id="successText">Success!</span>
                </div>
                
                <div id="errorMsg" class="alert alert-danger mt-3" style="display: none;">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="errorText">Error occurred</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentAction = '';
let stream = null;

function checkIn() {
    currentAction = 'checkin';
    document.getElementById('cameraModalTitle').innerHTML = '<i class="fas fa-sign-in-alt me-2"></i>Check In';
    openCamera();
}

function checkOut() {
    currentAction = 'checkout';
    document.getElementById('cameraModalTitle').innerHTML = '<i class="fas fa-sign-out-alt me-2"></i>Check Out';
    openCamera();
}

function showMessage(type, text) {
    // Hide all messages first
    document.getElementById('statusMsg').style.display = 'none';
    document.getElementById('processingMsg').style.display = 'none';
    document.getElementById('successMsg').style.display = 'none';
    document.getElementById('errorMsg').style.display = 'none';
    
    // Show the appropriate message
    if (type === 'status') {
        document.getElementById('statusText').textContent = text;
        document.getElementById('statusMsg').style.display = 'block';
    } else if (type === 'processing') {
        document.getElementById('processingText').textContent = text;
        document.getElementById('processingMsg').style.display = 'block';
    } else if (type === 'success') {
        document.getElementById('successText').textContent = text;
        document.getElementById('successMsg').style.display = 'block';
    } else if (type === 'error') {
        document.getElementById('errorText').textContent = text;
        document.getElementById('errorMsg').style.display = 'block';
    }
}

async function openCamera() {
    const modal = new bootstrap.Modal(document.getElementById('cameraModal'));
    modal.show();
    
    showMessage('status', 'Requesting camera access...');
    
    try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        document.getElementById('video').srcObject = stream;
        showMessage('status', 'Camera ready! Position your face in the center and click Capture.');
    } catch (err) {
        console.error('Error accessing camera:', err);
        showMessage('error', 'Unable to access camera. You can still check in/out without face recognition.');
    }
}

document.getElementById('captureBtn').addEventListener('click', function() {
    showMessage('processing', 'Capturing image...');
    
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0);
    
    const imageData = canvas.toDataURL('image/jpeg');
    processAttendance(imageData);
});

document.getElementById('skipBtn').addEventListener('click', function() {
    processAttendance(null);
});

async function processAttendance(imageData) {
    showMessage('processing', imageData ? 'Processing face recognition... This may take 5-10 seconds.' : 'Processing attendance...');
    document.getElementById('captureBtn').disabled = true;
    document.getElementById('skipBtn').disabled = true;
    
    try {
        // Get location if available
        let latitude = null, longitude = null;
        
        if (navigator.geolocation) {
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 5000 });
                });
                latitude = position.coords.latitude;
                longitude = position.coords.longitude;
            } catch (err) {
                console.log('Location not available:', err);
            }
        }
        
        const response = await fetch(`/attendance/${currentAction}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                image: imageData,
                latitude: latitude,
                longitude: longitude
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showMessage('success', `${currentAction === 'checkin' ? 'Check-in' : 'Check-out'} successful!`);
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showMessage('error', data.error || 'An error occurred');
        }
    } catch (err) {
        console.error('Error:', err);
        showMessage('error', 'Network error occurred. Please check your connection and try again.');
    } finally {
        closeCamera();
        document.getElementById('captureBtn').disabled = false;
        document.getElementById('skipBtn').disabled = false;
        document.getElementById('captureBtn').disabled = false;
        document.getElementById('skipBtn').disabled = false;
    }
}

function closeCamera() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
    }
    bootstrap.Modal.getInstance(document.getElementById('cameraModal')).hide();
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Close camera when modal is hidden
document.getElementById('cameraModal').addEventListener('hidden.bs.modal', closeCamera);
</script>
{% endblock %}
