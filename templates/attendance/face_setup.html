{% extends 'base.html' %}

{% block title %}Face Recognition Setup - Employee Attendance System{% endblock %}

{% block content %}
<div class="face-setup-container">
    <div class="text-center mb-4">
        <h1>
            <i class="fas fa-user-circle me-2"></i>Face Recognition Setup
        </h1>
        <p class="text-muted">Set up face recognition for secure and convenient attendance tracking</p>
    </div>

    {% if face_setup %}
    <div class="alert alert-success text-center" role="alert">
        <h4 class="alert-heading">
            <i class="fas fa-check-circle me-2"></i>Face Recognition Active
        </h4>
        <p>Your face recognition is already set up and working properly.</p>
        <hr>
        <button class="btn btn-warning" onclick="resetFaceSetup()">
            <i class="fas fa-redo me-2"></i>Reset Face Recognition
        </button>
    </div>
    {% else %}
    <div class="card">
        <div class="card-body">
            <h5 class="card-title text-center mb-4">
                <i class="fas fa-camera me-2"></i>Capture Your Face
            </h5>
            
            <div class="text-center mb-4">
                <video id="video" class="face-camera" autoplay></video>
                <canvas id="canvas" style="display: none;"></canvas>
            </div>
            
            <div class="d-grid gap-2">
                <button id="startCameraBtn" class="btn btn-primary btn-lg">
                    <i class="fas fa-video me-2"></i>Start Camera
                </button>
                <button id="captureBtn" class="btn btn-success btn-lg" style="display: none;">
                    <i class="fas fa-camera me-2"></i>Capture Face
                </button>
                <button id="retakeBtn" class="btn btn-outline-secondary" style="display: none;">
                    <i class="fas fa-redo me-2"></i>Retake Photo
                </button>
            </div>
            
            <!-- Status Messages -->
            <div id="statusMsg" class="alert alert-info mt-3" style="display: none;">
                <i class="fas fa-info-circle me-2"></i>
                <span id="statusText">Ready to capture...</span>
            </div>
            
            <div id="processingMsg" class="text-center mt-3" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Processing...</span>
                </div>
                <p class="mt-2" id="processingText">Processing face recognition setup...</p>
                <small class="text-muted">This may take 5-10 seconds</small>
            </div>
            
            <!-- Success/Error Messages -->
            <div id="successMsg" class="alert alert-success mt-3" style="display: none;">
                <i class="fas fa-check-circle me-2"></i>
                <span id="successText">Face recognition setup completed!</span>
            </div>
            
            <div id="errorMsg" class="alert alert-danger mt-3" style="display: none;">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <span id="errorText">Error occurred</span>
            </div>
            
            <div class="mt-4">
                <h6>Instructions:</h6>
                <ul class="text-muted">
                    <li>Ensure good lighting on your face</li>
                    <li>Look directly at the camera</li>
                    <li>Remove glasses if possible</li>
                    <li>Keep your face centered in the frame</li>
                </ul>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
let stream = null;
let faceSetup = {{ face_setup|lower }};

function showMessage(type, text) {
    // Hide all messages first
    document.getElementById('statusMsg').style.display = 'none';
    document.getElementById('processingMsg').style.display = 'none';
    document.getElementById('successMsg').style.display = 'none';
    document.getElementById('errorMsg').style.display = 'none';
    
    // Show the appropriate message
    if (type === 'status') {
        document.getElementById('statusText').textContent = text;
        document.getElementById('statusMsg').style.display = 'block';
    } else if (type === 'processing') {
        document.getElementById('processingText').textContent = text;
        document.getElementById('processingMsg').style.display = 'block';
    } else if (type === 'success') {
        document.getElementById('successText').textContent = text;
        document.getElementById('successMsg').style.display = 'block';
    } else if (type === 'error') {
        document.getElementById('errorText').textContent = text;
        document.getElementById('errorMsg').style.display = 'block';
    }
}

document.getElementById('startCameraBtn').addEventListener('click', async function() {
    showMessage('status', 'Requesting camera access...');
    
    try {
        stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                width: 640, 
                height: 480,
                facingMode: 'user'
            } 
        });
        
        const video = document.getElementById('video');
        video.srcObject = stream;
        
        showMessage('status', 'Camera ready! Position your face in the center and click Capture Face.');
        
        document.getElementById('startCameraBtn').style.display = 'none';
        document.getElementById('captureBtn').style.display = 'block';
        
    } catch (err) {
        console.error('Error accessing camera:', err);
        showMessage('error', 'Unable to access camera. Please check camera permissions and try again.');
    }
});

document.getElementById('captureBtn').addEventListener('click', function() {
    showMessage('processing', 'Capturing image...');
    
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0);
    
    const imageData = canvas.toDataURL('image/jpeg', 0.8);
    setupFaceRecognition(imageData);
});

document.getElementById('retakeBtn').addEventListener('click', function() {
    showMessage('status', 'Camera ready! Position your face in the center and click Capture Face.');
    document.getElementById('captureBtn').style.display = 'block';
    document.getElementById('retakeBtn').style.display = 'none';
});

async function setupFaceRecognition(imageData) {
    showMessage('processing', 'Analyzing face features... This may take 5-10 seconds.');
    document.getElementById('captureBtn').style.display = 'none';
    document.getElementById('retakeBtn').style.display = 'block';
    
    try {
        const response = await fetch('/face-capture/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                image: imageData
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showMessage('success', 'Face recognition setup completed successfully! You can now use face recognition for attendance.');
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showMessage('error', data.error || 'Face setup failed. Please ensure your face is clearly visible and try again.');
            document.getElementById('captureBtn').style.display = 'block';
            document.getElementById('retakeBtn').style.display = 'none';
        }
    } catch (err) {
        console.error('Error:', err);
        showMessage('error', 'Network error occurred. Please check your connection and try again.');
        document.getElementById('captureBtn').style.display = 'block';
        document.getElementById('retakeBtn').style.display = 'none';
    }
}

async function resetFaceSetup() {
    if (confirm('Are you sure you want to reset your face recognition? You will need to set it up again.')) {
        try {
            const response = await fetch('/api/attendance/face-remove/', {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('Face recognition has been reset successfully.');
                location.reload();
            } else {
                alert(data.error || 'Failed to reset face recognition.');
            }
        } catch (err) {
            console.error('Error:', err);
            alert('An error occurred. Please try again.');
        }
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Clean up camera stream when leaving page
window.addEventListener('beforeunload', function() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
    }
});
</script>
{% endblock %}
